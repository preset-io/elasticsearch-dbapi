# Python unit tests
name: Python

on:
  push:
    branches: ['master']
  pull_request:
    branches: ['master']

jobs:
  lint:
    runs-on: ubuntu-22.04
    strategy:
      matrix:
        python-version: ['3.10']
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ matrix.python-version }}
      - name: Install dependencies
        run: |
          pip install --upgrade pip
          pip install -r requirements.txt
          pip install -r requirements-dev.txt
      - name: black
        run: black --check setup.py es
      - name: flake8
        run: flake8 es
      - name: mypy
        run: mypy es

  tests:
    runs-on: ubuntu-22.04
    strategy:
      matrix:
        python-version: ['3.10', '3.11', '3.12']
    services:
      elasticsearch:
        image: docker.elastic.co/elasticsearch/elasticsearch:8.17.0
        env:
          discovery.type: single-node
          xpack.security.enabled: false
        ports:
          - 9200:9200
      opensearch:
        image: opensearchproject/opensearch:2.19.0
        env:
          discovery.type: single-node
          plugins.security.disabled: true
          DISABLE_INSTALL_DEMO_CONFIG: true
        ports:
          - 19200:9200

    steps:
      - uses: actions/checkout@v4
      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ matrix.python-version }}
      - name: Install dependencies
        run: |
          pip install --upgrade pip
          pip install -r requirements.txt
          pip install -r requirements-dev.txt
          pip install -e .
      - name: Wait for Elasticsearch
        run: |
          for i in {1..30}; do
            curl -s http://localhost:9200/_cluster/health && break
            echo "Waiting for Elasticsearch..."
            sleep 2
          done
      - name: Wait for OpenSearch
        run: |
          for i in {1..30}; do
            curl -s http://localhost:19200/_cluster/health && break
            echo "Waiting for OpenSearch..."
            sleep 2
          done
      - name: Run tests on Elasticsearch 8.x
        run: |
          export ES_URI="http://localhost:9200"
          export ES_PORT=9200
          pytest -v --cov=es --cov-report=xml es/tests
      - name: Run tests on OpenSearch 2.x
        run: |
          export ES_DRIVER=odelasticsearch
          export ES_URI="http://localhost:19200"
          export ES_PORT=19200
          export ES_SCHEME=http
          export ES_V2=True
          export ES_SUPPORT_DATETIME_PARSE=False
          pytest -v --cov=es --cov-report=xml --cov-append es/tests
      - name: Upload code coverage
        uses: codecov/codecov-action@v4
        with:
          files: ./coverage.xml
          fail_ci_if_error: false